---
# 외부 트래픽 → Web 라우팅 (Istio VirtualService + Gateway)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: web-virtualservice
  namespace: 3tier-app-21
spec:
  hosts:
  - "*"
  gateways:
  - 3tier-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: web
        subset: v1
        port:
          number: 80
      weight: 100
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,reset,connect-failure
---
# Web → WAS 내부 라우팅 (서비스 메시 내부 트래픽 제어)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: was-virtualservice
  namespace: 3tier-app-21
spec:
  hosts:
  - was
  http:
  - route:
    - destination:
        host: was
        subset: v1
        port:
          number: 8080
      weight: 100
    timeout: 60s
    retries:
      attempts: 3
      perTryTimeout: 15s
      retryOn: 5xx,reset,connect-failure,retriable-4xx
    headers:
      request:
        add:
          x-forwarded-by: "web-tier"
      response:
        add:
          x-served-by: "was-tier"
---
# WAS → DB 내부 라우팅 (TCP 트래픽 제어)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: db-virtualservice
  namespace: 3tier-app-21
spec:
  hosts:
  - db
  tcp:
  - match:
    - port: 3306
    route:
    - destination:
        host: db
        subset: v1
        port:
          number: 3306
      weight: 100
