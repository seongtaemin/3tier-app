apiVersion: v1
kind: ConfigMap
metadata:
  name: was-config

  labels:
    app: was
    tier: middleware
data:
  # 애플리케이션 설정
  application.properties: |
    # Database Connection
    spring.datasource.url=jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul
    spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
    spring.datasource.username=${DB_USER}
    spring.datasource.password=${DB_PASSWORD}

    # JPA 설정
    spring.jpa.hibernate.ddl-auto=update
    spring.jpa.show-sql=false
    spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect

    # 서버 설정
    server.port=8080
    server.servlet.context-path=/

    # 로깅 설정
    logging.level.root=INFO
    logging.level.org.springframework.web=INFO

  # JVM 옵션
  JAVA_OPTS: "-Xms512m -Xmx1024m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"

  # Tomcat 설정
  CATALINA_OPTS: "-Dspring.profiles.active=production -Dspring.config.location=file:/opt/app/config/application.properties"

  index.jsp: |
    <%@ page contentType="text/html; charset=UTF-8" %>
    <%@ page import="java.net.Socket" %>
    <%@ page import="java.net.InetSocketAddress" %>
    <%@ page import="java.net.InetAddress" %>
    <%@ page import="java.text.SimpleDateFormat" %>
    <%@ page import="java.util.Date" %>
    <%
        // Get Web Pod info from headers set by Nginx
        String webPodName = request.getHeader("X-Web-Pod-Name");
        String webPodIp = request.getHeader("X-Web-Pod-IP");
        if (webPodName == null) webPodName = "Unknown (Direct)";
        if (webPodIp == null) webPodIp = request.getRemoteAddr();

        String dbHost = System.getenv("DB_HOST");
        String dbPortStr = System.getenv("DB_PORT");
        int dbPort = (dbPortStr != null && !dbPortStr.isEmpty()) ? Integer.parseInt(dbPortStr) : 3306;
        
        String dbStatus = "Disconnected";
        String dbIp = "Unknown";
        boolean dbConnected = false;
        Socket socket = new Socket();
        try {
            socket.setSoTimeout(2000);
            socket.connect(new InetSocketAddress(dbHost, dbPort), 2000);
            if (socket.isConnected()) {
                dbConnected = true;
                dbStatus = "Connected to DB at " + dbHost + ":" + dbPort;
                try {
                    dbIp = InetAddress.getByName(dbHost).getHostAddress();
                } catch (Exception e) {}
            }
        } catch (Exception e) {
            dbStatus = "Error: " + e.getMessage();
        } finally {
            try { socket.close(); } catch(Exception e) {}
        }

        String currentTime = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());
    %>
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>3-Tier App Dashboard</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
        <style>
            *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

            body {
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                background: #0f172a;
                color: #e2e8f0;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
            }

            .dashboard {
                width: 100%;
                max-width: 720px;
            }

            /* Header */
            .header {
                text-align: center;
                margin-bottom: 36px;
            }

            .header .badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                background: rgba(34,197,94,0.1);
                border: 1px solid rgba(34,197,94,0.25);
                color: #4ade80;
                font-size: 12px;
                font-weight: 600;
                letter-spacing: 0.05em;
                text-transform: uppercase;
                padding: 6px 14px;
                border-radius: 100px;
                margin-bottom: 16px;
            }

            .badge .dot {
                width: 7px;
                height: 7px;
                background: #4ade80;
                border-radius: 50%;
                animation: pulse-dot 2s ease-in-out infinite;
            }

            @keyframes pulse-dot {
                0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(74,222,128,0.5); }
                50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(74,222,128,0); }
            }

            .header h1 {
                font-size: 28px;
                font-weight: 700;
                color: #f1f5f9;
                letter-spacing: -0.02em;
                margin-bottom: 6px;
            }

            .header p {
                font-size: 14px;
                color: #64748b;
            }

            /* Tier Cards */
            .tier-card {
                background: #1e293b;
                border: 1px solid #334155;
                border-radius: 14px;
                padding: 0;
                margin-bottom: 16px;
                overflow: hidden;
                transition: border-color 0.25s ease, box-shadow 0.25s ease;
            }

            .tier-card:hover {
                border-color: #475569;
                box-shadow: 0 8px 30px rgba(0,0,0,0.25);
            }

            .tier-header {
                display: flex;
                align-items: center;
                gap: 14px;
                padding: 20px 24px 0 24px;
            }

            .tier-icon {
                width: 44px;
                height: 44px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                flex-shrink: 0;
            }

            .tier-icon.web { background: rgba(59,130,246,0.12); color: #60a5fa; }
            .tier-icon.was { background: rgba(251,191,36,0.12); color: #fbbf24; }
            .tier-icon.db  { background: rgba(34,197,94,0.12);  color: #4ade80; }

            .tier-title-group { flex: 1; }

            .tier-title {
                font-size: 16px;
                font-weight: 600;
                color: #f1f5f9;
            }

            .tier-subtitle {
                font-size: 12px;
                color: #64748b;
                margin-top: 2px;
            }

            .tier-body {
                padding: 16px 24px 20px 24px;
            }

            .info-row {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 0;
                border-bottom: 1px solid rgba(51,65,85,0.5);
            }

            .info-row:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }

            .info-row:first-child {
                padding-top: 0;
            }

            .info-label {
                font-size: 13px;
                color: #94a3b8;
                font-weight: 500;
            }

            .info-value {
                font-family: 'JetBrains Mono', 'Courier New', monospace;
                font-size: 13px;
                font-weight: 500;
                color: #e2e8f0;
                background: rgba(15,23,42,0.6);
                padding: 4px 10px;
                border-radius: 6px;
                border: 1px solid #334155;
            }

            .status-badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-family: 'Inter', sans-serif;
                font-size: 12px;
                font-weight: 600;
                padding: 5px 12px;
                border-radius: 100px;
            }

            .status-badge.connected {
                background: rgba(34,197,94,0.1);
                border: 1px solid rgba(34,197,94,0.25);
                color: #4ade80;
            }

            .status-badge.error {
                background: rgba(239,68,68,0.1);
                border: 1px solid rgba(239,68,68,0.25);
                color: #f87171;
            }

            .status-badge .status-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
            }

            .status-badge.connected .status-dot { background: #4ade80; }
            .status-badge.error .status-dot { background: #f87171; }

            /* Architecture Diagram */
            .architecture {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0;
                margin: 28px 0 8px 0;
                padding: 20px 0;
            }

            .arch-node {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }

            .arch-circle {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                border: 2px solid;
            }

            .arch-circle.web { border-color: #3b82f6; color: #3b82f6; background: rgba(59,130,246,0.1); }
            .arch-circle.was { border-color: #fbbf24; color: #fbbf24; background: rgba(251,191,36,0.1); }
            .arch-circle.db  { border-color: #22c55e; color: #22c55e; background: rgba(34,197,94,0.1); }

            .arch-label {
                font-size: 11px;
                font-weight: 600;
                color: #64748b;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .arch-arrow {
                width: 60px;
                height: 2px;
                background: linear-gradient(90deg, #334155, #475569);
                margin: 0 4px;
                position: relative;
                top: -10px;
            }

            .arch-arrow::after {
                content: '';
                position: absolute;
                right: 0;
                top: -3px;
                width: 0;
                height: 0;
                border-top: 4px solid transparent;
                border-bottom: 4px solid transparent;
                border-left: 6px solid #475569;
            }

            .icon-svg {
                width: 24px;
                height: 24px;
            }

            /* Footer */
            .footer {
                text-align: center;
                margin-top: 32px;
                color: #475569;
            }

            .footer p {
                font-size: 13px;
                margin-bottom: 8px;
            }

            .footer .timestamp {
                font-size: 11px;
                font-family: 'JetBrains Mono', monospace;
                background: rgba(30,41,59,0.5);
                padding: 4px 12px;
                border-radius: 6px;
                display: inline-block;
            }
        </style>
    </head>
    <body>
        <div class="dashboard">
            <!-- Header -->
            <div class="header">
                <div class="badge">
                    <span class="status-dot"></span>
                    System Online
                </div>
                <h1>3-Tier Application Dashboard</h1>
                <p>Real-time infrastructure status overview</p>
            </div>

            <!-- Architecture Diagram -->
            <div class="architecture">
                <div class="arch-node">
                    <div class="arch-circle web">
                        <svg class="icon-svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5a17.92 17.92 0 0 1-8.716-2.247m0 0A8.966 8.966 0 0 1 3 12c0-1.264.26-2.466.732-3.558"/></svg>
                    </div>
                    <span class="arch-label">Web</span>
                </div>
                <div class="arch-arrow"></div>
                <div class="arch-node">
                    <div class="arch-circle was">
                        <svg class="icon-svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 0 1-3-3m3 3a3 3 0 1 0 0 6h13.5a3 3 0 1 0 0-6m-16.5-3a3 3 0 0 1 3-3h13.5a3 3 0 0 1 3 3m-19.5 0a4.5 4.5 0 0 1 .9-2.7L5.737 5.1a3.375 3.375 0 0 1 2.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 0 1 .9 2.7m0 0a3 3 0 0 1-3 3m0 3h.008v.008h-.008v-.008Zm0-6h.008v.008h-.008v-.008Zm-3 6h.008v.008h-.008v-.008Zm0-6h.008v.008h-.008v-.008Z"/></svg>
                    </div>
                    <span class="arch-label">WAS</span>
                </div>
                <div class="arch-arrow"></div>
                <div class="arch-node">
                    <div class="arch-circle db">
                        <svg class="icon-svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125"/></svg>
                    </div>
                    <span class="arch-label">DB</span>
                </div>
            </div>

            <!-- Web Tier Card -->
            <div class="tier-card">
                <div class="tier-header">
                    <div class="tier-icon web">
                        <svg class="icon-svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5a17.92 17.92 0 0 1-8.716-2.247m0 0A8.966 8.966 0 0 1 3 12c0-1.264.26-2.466.732-3.558"/></svg>
                    </div>
                    <div class="tier-title-group">
                        <div class="tier-title">Web Tier</div>
                        <div class="tier-subtitle">Nginx Frontend Server</div>
                    </div>
                </div>
                <div class="tier-body">
                    <div class="info-row">
                        <span class="info-label">Pod Name</span>
                        <span class="info-value"><%= webPodName %></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Pod IP</span>
                        <span class="info-value"><%= webPodIp %></span>
                    </div>
                </div>
            </div>

            <!-- WAS Tier Card -->
            <div class="tier-card">
                <div class="tier-header">
                    <div class="tier-icon was">
                        <svg class="icon-svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 0 1-3-3m3 3a3 3 0 1 0 0 6h13.5a3 3 0 1 0 0-6m-16.5-3a3 3 0 0 1 3-3h13.5a3 3 0 0 1 3 3m-19.5 0a4.5 4.5 0 0 1 .9-2.7L5.737 5.1a3.375 3.375 0 0 1 2.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 0 1 .9 2.7m0 0a3 3 0 0 1-3 3m0 3h.008v.008h-.008v-.008Zm0-6h.008v.008h-.008v-.008Zm-3 6h.008v.008h-.008v-.008Zm0-6h.008v.008h-.008v-.008Z"/></svg>
                    </div>
                    <div class="tier-title-group">
                        <div class="tier-title">WAS Tier</div>
                        <div class="tier-subtitle">Tomcat Middleware Server</div>
                    </div>
                </div>
                <div class="tier-body">
                    <div class="info-row">
                        <span class="info-label">Pod Name</span>
                        <span class="info-value"><%= InetAddress.getLocalHost().getHostName() %></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Pod IP</span>
                        <span class="info-value"><%= InetAddress.getLocalHost().getHostAddress() %></span>
                    </div>
                </div>
            </div>

            <!-- DB Tier Card -->
            <div class="tier-card">
                <div class="tier-header">
                    <div class="tier-icon db">
                        <svg class="icon-svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125"/></svg>
                    </div>
                    <div class="tier-title-group">
                        <div class="tier-title">DB Tier (Backend)</div>
                        <div class="tier-subtitle">MySQL Backend Database</div>
                    </div>
                    <span class="status-badge <%= dbConnected ? "connected" : "error" %>">
                        <span class="status-dot"></span>
                        <%= dbConnected ? "Connected" : "Disconnected" %>
                    </span>
                </div>
                <div class="tier-body">
                    <div class="info-row">
                        <span class="info-label">Host / Service</span>
                        <span class="info-value"><%= dbHost %></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Host IP</span>
                        <span class="info-value"><%= dbIp %></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value" style="<%= dbConnected ? "color:#4ade80;border-color:rgba(34,197,94,0.25);" : "color:#f87171;border-color:rgba(239,68,68,0.25);" %>"><%= dbStatus %></span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Each refresh may show a different pod as the load balancer routes your traffic.</p>
                <div class="timestamp">Last checked: <%= currentTime %></div>
            </div>
        </div>
    </body>
    </html>
